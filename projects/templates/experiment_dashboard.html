{% extends 'base.html' %} {% block title %}Dashboard - {{ experiment.title }} -
LeanLab{% endblock %} {% block extra_css %}
<style>
  .chart-container {
    position: relative;
    height: 350px;
    margin-bottom: 20px;
  }

  .badge-test-type {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
  }

  .gap-positive {
    color: #10b981;
    font-weight: bold;
  }

  .gap-negative {
    color: #ef4444;
    font-weight: bold;
  }
</style>
{% endblock %} {% block content %}

<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-4">
  <ol class="breadcrumb">
    <li class="breadcrumb-item">
      <a href="{% url 'projects:list' %}">Progetti</a>
    </li>
    <li class="breadcrumb-item">
      <a href="{% url 'projects:detail' project.pk %}">{{ project.name }}</a>
    </li>
    <li class="breadcrumb-item">
      <a href="{% url 'projects:experiment_detail' project.pk experiment.pk %}"
        >{{ experiment.title }}</a
      >
    </li>
    <li class="breadcrumb-item active">Dashboard</li>
  </ol>
</nav>

<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="mb-1">
      <i class="bi bi-graph-up-arrow text-info"></i> Dashboard Esperimento
    </h1>
    <p class="text-muted mb-0">{{ experiment.title }}</p>
  </div>
  <div class="btn-group">
    <a
      href="{% url 'projects:experiment_update_bigquery' project.pk experiment.pk %}"
      class="btn btn-warning"
    >
      <i class="bi bi-cloud-download"></i> Aggiorna da BigQuery
    </a>
    <a
      href="{% url 'projects:experiment_detail' project.pk experiment.pk %}"
      class="btn btn-outline-secondary"
    >
      <i class="bi bi-arrow-left"></i> Torna al Dettaglio
    </a>
  </div>
</div>

<!-- Riepilogo Esperimento -->
<div class="card mb-4">
  <div class="card-body">
    <div class="row">
      <div class="col-md-8">
        <h5 class="mb-2">
          <span
            class="badge {% if experiment.status == 'running' %}bg-info{% elif experiment.status == 'completed' %}bg-success{% else %}bg-secondary{% endif %} me-2"
          >
            {{ experiment.get_status_display }}
          </span>
          {% if experiment.decision != 'pending' %}
          <span
            class="badge {% if experiment.decision == 'persevere' %}badge-persevere{% else %}badge-pivot{% endif %}"
          >
            {{ experiment.get_decision_display }}
          </span>
          {% endif %}
        </h5>
        <div class="alert alert-light mb-0">
          <strong>Ipotesi:</strong> {{ experiment.hypothesis }}
        </div>
      </div>
      <div class="col-md-4">
        <div class="text-center p-3 bg-light rounded">
          <h2 class="text-primary mb-0">{{ indicators.count }}</h2>
          <p class="text-muted mb-0">Indicatori Monitorati</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Indicatori e Grafici -->
{% if chart_data %} {% for item in chart_data %}
<div class="card mb-4">
  <div class="card-header bg-light">
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="mb-0">
        <i class="bi bi-graph-up"></i> {{ item.indicator.name }}
      </h5>
      <div>
        <span
          class="badge badge-test-type {% if item.test_type == 'ab_test' %}bg-primary{% elif item.test_type == 'pre_post' %}bg-info{% else %}bg-secondary{% endif %} me-2"
        >
          {{ item.indicator.get_test_type_display }}
        </span>
        <span
          class="badge {% if item.indicator.role == 'primary' %}bg-primary{% elif item.indicator.role == 'guardrail' %}bg-danger{% else %}bg-secondary{% endif %}"
        >
          {{ item.indicator.get_role_display }}
        </span>
        {% if item.test_type != 'single' %}
        <span class="badge bg-warning text-dark ms-2">
          Target: +{{ item.indicator.target_uplift }}%
        </span>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="card-body">
    {% if item.results %}

    <!-- Grafico Chart.js -->
    <div class="chart-container mb-4">
      <canvas id="chart-{{ item.indicator.id }}"></canvas>
    </div>

    <!-- Tabella (varia per test_type) -->
    <div class="table-responsive">
      {% if item.test_type == 'ab_test' %}
      <!-- Tabella A/B Test -->
      <table class="table table-sm table-hover">
        <thead class="table-light">
          <tr>
            <th>Data</th>
            <th class="text-end">Control</th>
            <th class="text-end">Variant</th>
            <th class="text-end">Delta %</th>
            <th class="text-center">Decisione</th>
          </tr>
        </thead>
        <tbody>
          {% for result in item.results %}
          <tr>
            <td>{{ result.measured_at|date:"d/m/Y" }}</td>
            <td class="text-end">
              <strong>{{ result.value_control|floatformat:2 }}</strong>
            </td>
            <td class="text-end">
              <strong>{{ result.value_variant|floatformat:2 }}</strong>
            </td>
            <td class="text-end">
              <span
                class="{% if result.delta_percentage >= 0 %}text-success{% else %}text-danger{% endif %}"
              >
                <strong>{{ result.delta_percentage|floatformat:2 }}%</strong>
              </span>
            </td>
            <td class="text-center">
              <span
                class="badge {% if result.decision_auto == 'persevere' %}badge-persevere{% elif result.decision_auto == 'pivot' %}badge-pivot{% else %}bg-secondary{% endif %}"
              >
                {{ result.decision_auto|upper }}
              </span>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      {% elif item.test_type == 'pre_post' %}
      <!-- Tabella Pre/Post -->
      <table class="table table-sm table-hover">
        <thead class="table-light">
          <tr>
            <th>Data</th>
            <th class="text-end">Before</th>
            <th class="text-end">After</th>
            <th class="text-end">Delta %</th>
            <th class="text-center">Decisione</th>
          </tr>
        </thead>
        <tbody>
          {% for result in item.results %}
          <tr>
            <td>{{ result.measured_at|date:"d/m/Y" }}</td>
            <td class="text-end">
              <strong>{{ result.value_control|floatformat:2 }}</strong>
            </td>
            <td class="text-end">
              <strong>{{ result.value_variant|floatformat:2 }}</strong>
            </td>
            <td class="text-end">
              <span
                class="{% if result.delta_percentage >= 0 %}text-success{% else %}text-danger{% endif %}"
              >
                <strong>{{ result.delta_percentage|floatformat:2 }}%</strong>
              </span>
            </td>
            <td class="text-center">
              <span
                class="badge {% if result.decision_auto == 'persevere' %}badge-persevere{% elif result.decision_auto == 'pivot' %}badge-pivot{% else %}bg-secondary{% endif %}"
              >
                {{ result.decision_auto|upper }}
              </span>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      {% else %}
      <!-- Tabella Baseline -->
      <table class="table table-sm table-hover">
        <thead class="table-light">
          <tr>
            <th>Data</th>
            <th class="text-end">Valore Baseline</th>
            <th class="text-end">Target</th>
            <th class="text-end">Gap</th>
            <th class="text-center">Stato</th>
          </tr>
        </thead>
        <tbody>
          {% for result in item.results %}
          <tr>
            <td>{{ result.measured_at|date:"d/m/Y" }}</td>
            <td class="text-end">
              <strong class="text-primary"
                >{{ result.value_control|floatformat:2 }}</strong
              >
            </td>
            <td class="text-end text-muted">
              {% if item.indicator.target_uplift > 0 %} {{
              item.indicator.target_uplift|floatformat:2 }} {% else %}-{% endif
              %}
            </td>
            <td class="text-end">
              {% if item.indicator.target_uplift > 0 %} {% with
              gap=result.get_baseline_gap %} {% if gap is not None %} {% if gap
              >= 0 %}
              <span class="gap-positive">+{{ gap|floatformat:2 }}</span>
              {% else %}
              <span class="gap-negative">{{ gap|floatformat:2 }}</span>
              {% endif %} {% else %}
              <span class="text-muted">N/A</span>
              {% endif %} {% endwith %} {% else %}
              <span class="text-muted">-</span>
              {% endif %}
            </td>
            <td class="text-center">
              <span class="badge bg-secondary">Baseline</span>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% endif %}
    </div>
    {% endif %}
  </div>
</div>
{% endfor %} {% endif %} {% endblock %} {% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
  const chartData = {{ chart_data_json|safe }};

  chartData.forEach(data => {
      const ctx = document.getElementById(`chart-${data.indicatorId}`);
      const testType = data.testType;
      let chartConfig = {};

      if (testType === 'ab_test') {
          const targetLine = data.results.map(r => r.control * (1 + data.targetUplift / 100));
          chartConfig = {
              type: 'line',
              data: {
                  labels: data.results.map(r => r.date),
                  datasets: [
                      {
                          label: 'Control',
                          data: data.results.map(r => r.control),
                          borderColor: 'rgb(99, 102, 241)',
                          backgroundColor: 'rgba(99, 102, 241, 0.1)',
                          borderWidth: 3,
                          tension: 0.3,
                          pointRadius: 5
                      },
                      {
                          label: 'Variant',
                          data: data.results.map(r => r.variant),
                          borderColor: 'rgb(16, 185, 129)',
                          backgroundColor: 'rgba(16, 185, 129, 0.1)',
                          borderWidth: 3,
                          tension: 0.3,
                          pointRadius: 5
                      },
                      {
                          label: `Target (+${data.targetUplift}%)`,
                          data: targetLine,
                          borderColor: 'rgb(245, 158, 11)',
                          borderDash: [8, 4],
                          borderWidth: 2,
                          pointRadius: 0,
                          fill: false
                      }
                  ]
              },
              options: getChartOptions(data.indicatorName, 'A/B Test')
          };
      }
      else if (testType === 'pre_post') {
          const targetLine = data.results.map(r => r.before * (1 + data.targetUplift / 100));
          chartConfig = {
              type: 'line',
              data: {
                  labels: data.results.map(r => r.date),
                  datasets: [
                      {
                          label: 'Before',
                          data: data.results.map(r => r.before),
                          borderColor: 'rgb(239, 68, 68)',
                          backgroundColor: 'rgba(239, 68, 68, 0.1)',
                          borderWidth: 3,
                          tension: 0.3,
                          pointRadius: 6
                      },
                      {
                          label: 'After',
                          data: data.results.map(r => r.after),
                          borderColor: 'rgb(16, 185, 129)',
                          backgroundColor: 'rgba(16, 185, 129, 0.1)',
                          borderWidth: 3,
                          tension: 0.3,
                          pointRadius: 6
                      },
                      {
                          label: `Target (+${data.targetUplift}%)`,
                          data: targetLine,
                          borderColor: 'rgb(245, 158, 11)',
                          borderDash: [8, 4],
                          borderWidth: 2,
                          pointRadius: 0,
                          fill: false
                      }
                  ]
              },
              options: getChartOptions(data.indicatorName, 'Pre/Post Test')
          };
      }
      else {  // 'single' - ✅ CORRETTO
          const baselineValues = data.results.map(r => r.baseline);

          // ✅ FIX: targetUplift è valore assoluto per baseline
          let targetValues;
          if (data.targetUplift > 0) {
              targetValues = data.results.map(r => data.targetUplift);  // ✅ Linea piatta al valore target
          } else {
              targetValues = baselineValues;
          }

          chartConfig = {
              type: 'line',
              data: {
                  labels: data.results.map(r => r.date),
                  datasets: [
                      {
                          label: 'Baseline Misurata',
                          data: baselineValues,
                          borderColor: 'rgb(99, 102, 241)',
                          backgroundColor: 'rgba(99, 102, 241, 0.2)',
                          borderWidth: 3,
                          tension: 0.3,
                          pointRadius: 6,
                          fill: true
                      },
                      {
                          label: data.targetUplift > 0 ? `Target (${data.targetUplift.toFixed(1)})` : 'Riferimento',
                          data: targetValues,
                          borderColor: 'rgb(245, 158, 11)',
                          borderDash: [8, 4],
                          borderWidth: 2,
                          pointRadius: 0,
                          fill: false
                      }
                  ]
              },
              options: getChartOptions(data.indicatorName, 'Baseline')
          };
      }

      new Chart(ctx, chartConfig);
  });

  function getChartOptions(indicatorName, chartType) {
      return {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
              legend: {
                  position: 'top',
                  labels: {
                      usePointStyle: true,
                      padding: 15,
                      font: { size: 12, weight: 'bold' }
                  }
              },
              title: {
                  display: true,
                  text: `${indicatorName} - ${chartType}`,
                  font: { size: 16, weight: 'bold' },
                  padding: { bottom: 20 }
              }
          },
          scales: {
              y: {
                  beginAtZero: true,
                  title: { display: true, text: 'Valore' }
              },
              x: {
                  title: { display: true, text: 'Data' }
              }
          }
      };
  }
</script>
{% endblock %}
